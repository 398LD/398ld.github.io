function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,a=new Array(e.length);t<e.length;t++)a[t]=e[t];return a}}!function(e){function t(e,t){return moment(e)-moment(t)>0}epctrl.Calendar=function(t){epctrl.Calendar.superclass.constructor.apply(this,arguments),this.cfg=t||{};var a=this.cfg.mallOptions.optionsAmountList||[];e.each(a,function(e,t){var a=t.t2,n=a.substr(a.lastIndexOf("_")+1);t.date=n}),this.cfg.priceCalendar&&(this.filtedOptions=a,this.defaultPrice=0,this.defaultAmount=0),(this.cfg.mallOptions.themeV3||Fai.top._openThemeV3)&&(this.themeV3=!0)},epctrl.extend("Calendar","Control",{type:"Calendar",selectedCls:"ep-calendar-selected",selectStart:"",selectEnd:"",_defaultCfg:{width:"",height:"",date:"",showBorder:!0,autoReRender:!0,dayStartFromSunday:!0,headerHeight:"",footerHeight:"",menuHeigt:240,menuWidth:220,multiSelect:null},_initContainer:function(){this.$container.empty();var e=document.createElement("div");e.className="ep-calendar",this.cfg.width&&(e.style.width=this.cfg.width),this.showBorder||(e.style.border="none"),this.el=e;var t=document.createElement("div"),a=document.createElement("div");t.className="ep-calendar-header",t.innerHTML='<span class="ep-calendar-header-btn ep-calendar-btn-prev"><svg class="icon_arrow"><use xlink:href="#jzm-v1"></use></svg></span><div class="ep-calendar-header-center"><span class="ep-calendar-title"></span></div><span class="ep-calendar-header-btn ep-calendar-btn-next"><svg class="icon_arrow1"><use xlink:href="#jzm-v2"></use></svg></span>',a.className="ep-calendar-bg-holder",t.innerHTML+="",this.cfg.headerHeight&&(t.style.height=this.cfg.headerHeight),this._header=t,this._prevBtn=t.firstChild,this._nextBtn=t.lastChild,this._headerCenter=this._prevBtn.nextSibling,this._titleEl=this._headerCenter.firstChild,this.el.appendChild(t),this.el.appendChild(a);var n=document.createElement("table"),r=document.createElement("thead"),i=document.createElement("tbody"),s=document.createElement("tr");n.className="ep-calendar-body",n.setAttribute("cellspacing",0),n.setAttribute("cellpadding",0),s.className="ep-calendar-daysheader",i.className="ep-calendar-days",r.appendChild(s),n.appendChild(r),n.appendChild(i),this._daysHeader=s,this._daysBody=i,this.el.appendChild(n),this._body=n;var l=document.createElement("div");l.className="ep-calendar-footer",this.cfg.footerHeight&&(t.style.height=this.cfg.footerHeight),this.el.appendChild(l),this._footer=l;var d=document.createElement("div");d.className="ep-calendar-menu",this.cfg.menuHeigt&&(d.style.height=this.cfg.menuHeigt),this.cfg.menuWidth&&(d.style.menuWidth=this.cfg.menuWidth),this.menu=d,this.el.appendChild(d),this.container.appendChild(this.el)},_calcAndSetHeight:function(){var t=e(this._header).outerHeight(),a=e(this._footer).outerHeight(),n=e(this.el).height()-t-a;this._body.style.height=n+"px"},_weekHeaderDays:{Sun:["日","一","二","三","四","五","六"],Sun_full:["周日","周一","周二","周三","周四","周五","周六"],Sun_en:["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],Sun_en_full:["Sunday","Monday","Tuesday","Wednesday","Thurday","Friday","Saturday "],Mon:["一","二","三","四","五","六","日"],Mon_full:["周一","周二","周三","周四","周五","周六","周日"],Mon_en:["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],Mon_en_full:["Monday","Tuesday","Wednesday","Thurday","Friday","Saturday","Sunday"]},_renderWeek:function(){var t=this.dayStartFromSunday?this._weekHeaderDays.Sun:this._weekHeaderDays.Mon;2052!==Fai.top._lcid&&(t=this.dayStartFromSunday?this._weekHeaderDays.Sun_en:this._weekHeaderDays.Mon_en);for(var a=0;a<7;++a){var n=document.createElement("th"),r=document.createElement("div"),i=document.createElement("span"),s=this.dayStartFromSunday?0===a?7:a:a+1;n.className="ep-calendar-day",r.className="ep-calendar-day-inner",n.setAttribute("data-isoweekday",s),r.appendChild(i),n.appendChild(r);var l=this.fire("cellRender",{isoWeekday:s,dayCls:"ep-calendar-day-text",dayText:t[a],el:this.el,tdEl:n,extraHtml:"",isHeader:!0});i.className=l.dayCls,i.innerText=l.dayText,l.extraHtml&&e(l.extraHtml).appendTo(r),this._daysHeader.appendChild(n),this.fire("afterCellRender",{isoWeekday:s,dayCls:i.className,dayText:i.innerText,el:this.el,isHeader:!0,extraHtml:l.extraHtml,tdEl:n})}},_renderTitle:function(){var e="YYYY年M月";2052!==Fai.top._lcid&&(e="M-YYYY"),this._titleEl.innerHTML=moment(this.currMonth,"YYYY-MM").format(e),this.fire("titleRender",{titleEl:this._titleEl,currMonth:this.currMonth})},_clearDays:function(){for(var e=this._daysBody.childNodes,t=e.length;t>0;--t)this._daysBody.removeChild(e[t-1])},_renderDay:function(a,n){var r,i=this,s=document.createElement("td"),l=document.createElement("div"),d=document.createElement("div"),o=document.createElement("div"),c=document.createElement("div"),h=document.createElement("div"),m=document.createElement("div"),u=a.isoWeekday(),f=a.month()+1,p=a.format("YYYY-MM-DD"),M=f!=parseInt(this.currMonth.substr(5),10)||!moment(this.today).isSameOrBefore(a);if(o.classList.add("ep-background-box"),this.themeV3?o.classList.add("g_main_bgColor_v3"):o.classList.add("g_bgColor"),s.appendChild(o),l.appendChild(d),h.classList.add("ep-calendar-label"),this.cfg.multiSelect&&this.cfg.multiSelect.startLabel&&this.selectStart==p?(h.innerHTML=this.cfg.multiSelect.startLabel,l.appendChild(h)):this.cfg.multiSelect&&this.cfg.multiSelect.endLabel&&this.selectEnd==p?(h.innerHTML=this.cfg.multiSelect.endLabel,l.appendChild(h)):(l.appendChild(c),this.cfg.openAmount&&l.appendChild(m)),s.appendChild(l),this.cfg.multiSelect&&!M)if(this.selectStart==p||this.selectEnd==p)(r=s.classList).add.apply(r,_toConsumableArray(this.selectedCls.split(" ")));else if(this.selectStart&&this.selectEnd&&t(p,this.selectStart)&&t(this.selectEnd,p)){var y;(y=s.classList).add.apply(y,_toConsumableArray(this.selectedCls.split(" ")).concat(["ep-calendar-range-selected"]))}s.classList.add("ep-calendar-date"),l.className="ep-calendar-date-inner",s.setAttribute("data-date",p),s.setAttribute("data-isoweekday",u),d.className="ep-calendar-date-txt",c.className="ep-calendar-price-txt",this.themeV3?c.className+=" g_main_color_v3":c.className+=" g_mainColor",m.className="ep-calendar-inv-txt",6!==u&&7!==u||(s.className+=" ep-calenday-weekend"),M&&(s.className+=" ep-calendar-invaild"),this.today==p&&(s.className+=" ep-calendar-today");var Y=this.fire("cellRender",{date:a.format("YYYY-MM-DD"),isoWeekday:u,el:this.el,tdEl:s,dateText:a.date(),dateCls:"ep-calendar-date-txt",extraHtml:"",isHeader:!1});if(f==parseInt(this.currMonth.substr(5),10)&&(d.innerText=Y.dateText),0==this.filtedOptions.length&&f==parseInt(this.currMonth.substr(5),10)&&moment(this.today).isSameOrBefore(a)){var g=!1;""===this.defaultPrice&&(g=!0);var v="",_=Number(this.defaultPrice);this.cfg.useMk&&(_=Number(this.cfg.mkPrice)),_=this._onlyChangeSalePrice(_),v=Math.floor(_)===_?_.toFixed(0):_.toFixed(2),s.setAttribute("price",v),c.innerHTML=g?"":this.cfg.mallOptions.choiceCurrencyVal+v,m.innerText="余0",s.className+=" ep-calendar-disabled"}else if(f==parseInt(this.currMonth.substr(5),10)&&moment(this.today).isSameOrBefore(a)){var C=!1,b=e(".J-op-box"),S=b.find(".J-op");1==i.cfg.mallOptions.entry&&(b=e("#productMallOptionPanel"+i.cfg.mallOptions.productId+" .J-op-box"),S=b.find(".J-op"));var D=b.find(".optionSelected"),E=Array.from(S);S=E.filter(function(t){return!("true"===e(t).attr("isTime"))}),e.each(this.filtedOptions,function(e,t){if(p==t.date){var a=!1;void 0!==t.oPrice&&null!=t.oPrice&&""!==t.oPrice||(t.oPrice=i.defaultPrice,a=!0);var n="",r=Number(t.oPrice);S.length!=D.length&&i.defaultPrice&&(r=i.defaultPrice),i.cfg.useMk&&(r=Number(i.cfg.mkPrice)),r=i._onlyChangeSalePrice(r),n=Math.floor(r)===r?r.toFixed(0):r.toFixed(2),s.setAttribute("price",n),c.innerHTML=a?"":i.cfg.mallOptions.choiceCurrencyVal+n,void 0!==t.oAmount&&null!=t.oAmount&&""!==t.oAmount||(t.oAmount=i.defaultAmount),m.innerText="余"+t.oAmount,i.cfg.openAmount&&0==t.oAmount&&(s.className+=" ep-calendar-disabled"),C=!0}}),C||(s.className+=" ep-calendar-disabled")}Y.extraHtml&&e(Y.extraHtml).appendTo(l),n.appendChild(Y.tdEl),this.fire("afterCellRender",{date:a.format("YYYY-MM-DD"),isoWeekday:u,el:this.el,tdEl:s,dateText:d.innerText,dateCls:d.className,extraHtml:Y.extraHtml,isHeader:!1})},_render:function(){this._initStartEnd();var t,a=this.startDateOfMonth.clone(),n=e.Deferred(),r=this.startDateOfMonth.format("YYYY-MM-DD"),i=this.endDateOfMonth.format("YYYY-MM-DD"),s=moment(this.currMonth,"YYYY-MM").subtract(1,"M"),l=moment().startOf("month");s.isBefore(l)&&e(".ep-calendar-btn-prev").addClass("btn-disabled");var d=moment(this.currMonth,"YYYY-MM").add(1,"M"),o=moment().add(12,"M");d.isAfter(o)&&e(".ep-calendar-btn-next").addClass("btn-disabled");var c=this.fire("beforeDateRender",{momth:this.currMonth,startDate:r,endDate:i,ajax:null});c.ajax||(c.ajax=n.promise(),n.resolve());var h=this;c.ajax.then(function(){h._clearDays(),h._renderTitle();for(var e=0;e<6;++e){(t=document.createElement("tr")).className="ep-calendar-week",h._daysBody.appendChild(t);for(var n=0;n<7;++n)h._renderDay(a,t),a.add(1,"day")}h.fire("afterDateRender",{momth:h.currMonth,startDate:r,endDate:i,ajax:c.ajax})})},render:function(e){if(e){var t=moment(e,"YYYY-MM");t.isValid()?this.currMonth=t.format("YYYY-MM"):this.throwError(e+"指定的日期不正确！")}this.cfg.priceCalendar&&this._initOptionsListener(),this._isInit||(this._initContainer(),this._renderWeek(),this._isInit=!0),this._render()},reRender:function(){this._isInit||this.throwError("日历还未渲染过，无需重新渲染！"),this._initContainer(),this._renderWeek(),this.render()},_initOptionsListener:function(){var t=this,a=t.cfg.mallOptions||{},n=a.optionsAmountList,r=(a.isRelateAmount,a.realMallPrice),i=(a.limitAmount_options,a.productRestrictInfo,a.choiceCurrencyVal,a.entry),s=a.productId,l=(a.moduleId,a.weightTypeStr),d=(a.isGroupBuy,a.groupPrice,a.isCutPrice,a.cpMinPrice,a.isSecKill,a.secKillPrice,a.isIntegralMall,a.integtalMallType,a.imMinPrice,Fai.top._openThemeV3,!1);e.each(n,function(e,t){if(null==t.t)return d=!0,!1}),null==l&&(l="kg");var o=e(".J-op-box"),c=(e(".mallOptionImg"),o.find(".J-op"));1==i&&(o=e("#productMallOptionPanel"+s+" .J-op-box"),e("#productMallOptionPanel"+s+" .mallOptionImg"),c=o.find(".J-op"));var h=Array.from(c);c=h.filter(function(t){return!("true"===e(t).attr("isTime"))});e("#mallPrice").html();var m=e("#mallAmount").html();e("#mallWeight").html();t.defaultPrice=r,e("#mallAmount").length>0&&(t.defaultAmount=m),e(c).each(function(a){e(this).find("label").click(function(){t.filtedOptions=[];var a=o.find(".optionSelected");if(c.length==a.length){var r="";e(a).each(function(t){r+=d?e(this).attr("data")+"_":e(this).attr("data")}),e.each(n,function(e,a){var n=a.t2,i=n.substr(n.lastIndexOf("_")+1);n.substr(0,n.lastIndexOf("_")+1)==r&&(a.date=i,t.filtedOptions.push(a))})}t._render()})})},_onlyChangeSalePrice:function(t){if(t=parseFloat(t),isNaN(t))return t;var a=Mobi.salePromotionDetail.salePromotionParam;if(void 0===a||null==a||""==a)return t;var n=!1;if(e.each(this.cfg.mallOptions.saleIdList,function(e,t){t===a.id&&(n=!0)}),!n)return t;if("1"==Mobi.salePromotionDetail.showType)return t;if("1"==a.saleType){var r=parseFloat(a.other.ruleData.d[0].m),i=0;return(i="1"==a.other.ruleData.s?t*(r/10):t-r)<0&&(i=0),i}return t},_initStartEnd:function(){var e,t,a=moment(this.currMonth,"YYYY-MM"),n=a.isoWeekday();t=(e=this.dayStartFromSunday?a.subtract(n,"day"):a.subtract(n-1,"day")).clone().add(41,"day"),this.startDateOfMonth=e,this.endDateOfMonth=t},setMonth:function(e){var t=moment(e,"YYYY-MM");if(!t.isValid())throw new Error(e+"是一个不合法的日期");var a=this.currMonth,n=t.format("YYYY-MM");this.fire("beforeMonthChange",{el:this.el,oldMonth:a,newMonth:n}),this.currMonth=n,this.render(),this.fire("afterMonthChange",{el:this.el,oldMonth:a,newMonth:n})},getMonth:function(){return this.currMonth},prevMonth:function(){var t=moment(this.currMonth,"YYYY-MM").subtract(1,"M"),a=moment().startOf("month");t.isBefore(a)?e(".ep-calendar-btn-prev").addClass("btn-disabled"):(this.setMonth(t),e(".ep-calendar-btn-next").removeClass("btn-disabled"))},nextMonth:function(){var t=moment(this.currMonth,"YYYY-MM").add(1,"M"),a=moment().add(12,"M");t.isAfter(a)?e(".ep-calendar-btn-next").addClass("btn-disabled"):(this.setMonth(t),e(".ep-calendar-btn-prev").removeClass("btn-disabled"))},setSelected:function(a){var n,r,i=/^\d{1,2}$/.test(a),s=e(this._daysBody).find(".ep-calendar-date");if(i)return(r=moment(this.currMonth+"-"+a,"YYYY-MM-DD")).isValid()||this.throwError("日期不合法"),void((n=this._getTd(r,s)).length?(s.removeClass(this.selectedCls),n.addClass(this.selectedCls)):this.throwError("当前月中没有"+a+"这一天！"));if((r=moment(a,"YYYY-MM-DD")).isValid())if(this.cfg.multiSelect){n=this._getTd(r,s);var l=a;!this.selectEnd&&this.selectStart&&t(l,this.selectStart)&&!this.isDateRangeHasDisabled(s,this.selectStart,l)?(this.selectEnd=l,this.fire("totalPriceChange",{price:this.calTotalPrice(s,this.selectStart,this.selectEnd)})):n.hasClass("ep-calendar-disabled")||(this.selectStart=l,this.selectEnd="",this.fire("totalPriceChange",{price:0})),this.render(r.format("YYYY-MM"))}else(n=this._getTd(r,s)).length?(s.removeClass(this.selectedCls),n.addClass(this.selectedCls)):this.autoReRender?(this.render(r.format("YYYY-MM")),this.setSelected(a)):this.throwError("指定日期不在当前视图，且未开启自动切换，无法设置！");else this.throwError(a+",此日期不合法！")},getSelected:function(){if(this.cfg.multiSelect){if(this.selectStart&&this.selectEnd){var t=moment(this.selectEnd,"YYYY-MM-DD").add(-1,"days").format("YYYY-MM-DD");return"".concat(this.selectStart,"_").concat(t)}return""}var a=e(".ep-calendar-selected",this._daysBody)[0];return a?moment(a.getAttribute("data-date"),"YYYY-MM-DD").format("YYYY-MM-DD"):""},getStartEnd:function(){return{start:this.startDateOfMonth.format("YYYY-MM-DD"),end:this.endDateOfMonth.format("YYYY-MM-DD")}},_getTd:function(t,a){return(a=a||e(this._daysBody).find(".ep-calendar-date")).filter('[data-date="'+t.format("YYYY-MM-DD")+'"]')},getELByDate:function(e){var t;t=/^\d{1,2}$/.test(e)?moment(this.currMonth+"-"+e,"YYYY-MM-DD"):/^\d{1,2}-\d{1,2}$/.test(e)?moment((new Date).getFullYear()+"-"+e,"YYYY-MM-DD"):moment(e,"YYYY-MM-DD");var a=this._getTd(t);return a.length?a[0]:null},goToday:function(){return this.today=moment().format("YYYY-MM-DD"),this.setMonth(this.today)},reset:function(){this.selectEnd=this.selectStart="",this.setMonth(this.cfg.date||new Date),this.render(),this.fire("totalPriceChange",{price:0})},_initEvent:function(){var t=this;e(this.el).on("click",".ep-calendar-date",function(a){var n=this.getAttribute("data-date"),r=t.fire("dayClick",{ev:a,date:n,day:this.getAttribute("data-isoweekday"),el:t.el,tdEl:this,value:t.getSelected()});t.cfg.multiSelect?r.cancel||e(this).hasClass("ep-calendar-invaild")||t.setSelected(n):r.cancel||e(this).hasClass("ep-calendar-disabled")||e(this).hasClass("ep-calendar-invaild")||t.setSelected(n)}).on("click",".ep-calendar-day",function(e){t.fire("dayHeaderClick",{ev:e,day:this.getAttribute("data-isoweekday"),el:t.el,tdEl:this})}).on("click",".ep-calendar-btn-prev",function(e){t.fire("prevBtnClick",{ev:e,currMonth:t.currMonth,el:t.el}).cancel||t.prevMonth()}).on("click",".ep-calendar-btn-next",function(e){t.fire("nextBtnClick",{ev:e,currMonth:t.currMonth,el:t.el}).cancel||t.nextMonth()}).on("click",".ep-calendar-menu-month,.ep-calendar-menu-year",function(){e(this).addClass("selected").siblings(".selected").removeClass("selected")}).on("click",".ep-calendar-okbtn",function(){var a=e(t.menu_year).find(".ep-calendar-menu-year.selected").data("year"),n=e(t.menu_month).find(".ep-calendar-menu-month.selected").data("month");a&&n?(t.setMonth(a+"-"+n),t.hideMenu()):t.hideMenu()}).on("click",".ep-calendar-cancelbtn",function(){t.hideMenu()}).on("click",".ep-calendar-next-year,.ep-calendar-prev-year",function(){var a,n=e(this),r=parseInt(t.menu_year.firstChild.getAttribute("data-year"),10);n.hasClass("ep-calendar-prev-year")?a=r-10:n.hasClass("ep-calendar-next-year")&&(a=r+10),t._renderYear(a)}),e(document.body).on("click",function(a){var n=e(a.target);n.closest(".ep-calendar-menu").length||n.closest(".ep-calendar-title").length||t.hideMenu()})},hideMenu:function(){this.menu.className=this.menu.className.replace(" show","")},showMenu:function(e){this._onMenuShow(e)},_onMenuShow:function(t){t=t||this.currMonth,this.menu.className+=" show";var a=t.split("-"),n=parseInt(a[0],10),r=parseInt(a[1],10);this.menuIsInit?(this._renderYear(n),e(this.menu_month).find('[data-month="'+r+'"]').addClass("selected").siblings().removeClass("selected")):(this._initMenu(n,r),this.menuIsInit=!0)},_initMenu:function(e,t){var a=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div"),i=document.createElement("div"),s=document.createElement("span"),l=document.createElement("span"),d=document.createElement("span"),o=document.createElement("span");a.className="ep-calendar-menu-months",n.className="ep-calendar-menu-years",r.className="ep-calendar-menu-years-inner",i.className="ep-calendar-menu-footer",s.className="ep-calendar-okbtn",s.innerText="确定",l.innerText="取消",l.className="ep-calendar-cancelbtn",d.className="ep-calendar-prev-year",o.className="ep-calendar-next-year",i.appendChild(s),i.appendChild(l),n.appendChild(r),n.appendChild(d),n.appendChild(o),this.menu_month=a,this.menu_year=r,this.menu.appendChild(a),this.menu.appendChild(n),this.menu.appendChild(i),this._renderMonth(t),this._renderYear(e,e)},_renderMonth:function(e){var t,a=1,n=this.menu_month,r=document.createElement("span");for(r.className="ep-calendar-menu-month";a<13;)t=r.cloneNode(!0),a==e&&(t.className+=" selected"),t.innerText=a+"月",t.setAttribute("data-month",a),n.appendChild(t),++a},_renderYear:function(e,t){t=t||parseInt(this.currMonth.split("-")[0],10);var a,n,r=0,i=this.menu_year,s=document.createElement("span");for(i.innerHTML="",s.className+="ep-calendar-menu-year";r<10;)n=s.cloneNode(),(a=e+r)===t&&(n.className+=" selected"),n.innerText=a,n.setAttribute("data-year",a),i.appendChild(n),++r},initCfg:function(){if(!this.cfg||!this.cfg.el)throw new Error("必须指定日历渲染的html元素");this.cfg=e.extend({},this._defaultCfg,this.cfg),this.$container=e(this.cfg.el),this.container=this.$container[0],this.currMonth=this.cfg.date?moment(this.cfg.date,"YYYY-MM").format("YYYY-MM"):moment().format("YYYY-MM"),this.today=moment().format("YYYY-MM-DD"),this.dayStartFromSunday=this.cfg.dayStartFromSunday,this.autoReRender=this.cfg.autoReRender,this.showBorder=this.cfg.showBorder},create:function(){this.fire("beforeCreate"),this.initCfg(),this.render(),this._initEvent(),this.fire("afterCreate"),this.fire("totalPriceChange",{price:0})},isDateRangeHasDisabled:function(e,t,a){for(var n=moment(t),r=moment(a),i=n.clone();i.add(1,"days")<r;){var s=e.filter('[data-date="'.concat(i.format("YYYY-MM-DD"),'"]'));if(s.length&&s.hasClass("ep-calendar-disabled"))return!0}return!1},calTotalPrice:function(e,t,a){var n=moment(t),r=moment(a),i=n.clone(),s=0;do{var l=e.filter('[data-date="'.concat(i.format("YYYY-MM-DD"),'"]'))[0];l&&(s+=+l.getAttribute("price")||0)}while(i.add(1,"days")<r);return s}})}(jm);